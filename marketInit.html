<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no"/>
    <link rel="stylesheet" href="css/main.css"/>
    <link rel="stylesheet" href="css/component.css"/>
    <style type="text/css">
        .container {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            top: 0%;
            left: 0%;
        }

        .inputWay {
            text-align: center;
            font-size: 2rem;
            margin: 3rem auto;
        }

        .bottom {
            position: absolute;
            bottom: 0;
            height: 10rem;
            width: 100%;
            border-top: 1px solid black;
            box-sizing: border-box;
            padding: 1rem;
        }

        .alreadyInsert {
            float: left;
        }

        .insertCheck {
            float: right;
        }

        .finishInsert {
            clear: both;
            text-align: center;
            width: 50%;
            margin: 3rem auto 0;
            height: 3rem;
            line-height: 3rem;
        }
    </style>
    <title>产品录入</title>
</head>
<body>
<div class="container" id='conInput'>
    <div class='inputWay' id='saoma'>条码扫描</div>
    <div class='inputWay' id='shoudong'>手动输入</div>
    <div class='bottom'>
        <div class='row1'><span class='alreadyInsert'>已录入产品</span><span class='insertCheck'>查看</span></div>
        <div class='finishInsert normalBtn'>完成录入</div>
    </div>
</div>
<div class="container" id='conMatch'>匹配成功</div>
<div class="container" id='conNotMatch'>匹配失败</div>

<script src='http://res.wx.qq.com/open/js/jweixin-1.1.0.js'></script>
<script src="http://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js"></script>
<script src='js/tool/response.js'></script>
<script src='js/controller/controller.js'></script>
<script src='js/tool/fastclick.js'></script>
<script src='js/constant/jimiHost.js'></script>

<script>
    $(function () {

        window.onerror = function (sMsg, sUrl, sLine) {
            alert(sMsg);
            alert(sUrl);
            alert(sLine);
        }

        FastClick.attach(document.body);

        //jqObj..............................................................
        $containers = $('.container');

        //initDom................................................................
        $containers.eq(0).show().siblings('.container').hide();

        //paras..............................................................
        var url = 'http://' + window.location.host + window.location.pathname;


        //initAjax........................................................
        $.ajax({
            type: "get",
            url: jimiHost + '/getWxConfig.php',
            dataType: "jsonp",
            jsonp: "callback",
            jsonpCallback: "jsonpcallback",
            data: {url: url},
            success: function (data) {
                console.log(JSON.stringify(data));

                wx.config({
                    debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                    appId: data.appId, // 必填，公众号的唯一标识
                    timestamp: data.timestamp, // 必填，生成签名的时间戳
                    nonceStr: data.nonceStr, // 必填，生成签名的随机串
                    signature: data.signature,// 必填，签名，见附录1
                    jsApiList: [
//                        'getLocation',
//                        'chooseImage',
//                        'openLocation',
                        'scanQRCode'
                    ]
                });


                wx.error(function (res) {
                    alert(res);

                });

                wx.ready(function () {
                    //bindEvent.............................................................

                    $('#saoma').click(function () {
                        wx.scanQRCode({
                            needResult: 1, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
                            scanType: ["barCode"], // 可以指定扫二维码还是一维码，默认二者都有
                            success: function (res) {
                                var errMsg = res.errMsg;
                                var result = res.resultStr; // 当needResult 为 1 时，扫码返回的结果
                                var lineCode = result.split(',')[1];

                                controller.checkLineCode({
                                    jsoncallback: 1,
                                    regcode: lineCode,
                                }, function (json) {
                                    if (Object.prototype.toString.call(json) == "[object Array]") {
                                        var product = json[0];
                                        var pid = product.pid;
                                        var imgUrl = product.imgUrl;
                                        var pname = product.pname;

                                        alert('match');
                                        $('#conMatch').show().siblings('.container').hide();
                                    } else {
                                        alert('notMatch');
                                        $('#conNotMatch').show().siblings('.container').hide();
                                    }
                                })
                            }
                        });
                    })

                })

            },
            error: function (err) {
                console.log('ERROR!');
                console.log(err);
            }
        });
    })
</script>
</body>
</html>