<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no"/>
    <link rel="stylesheet" href="css/main.css"/>
    <link rel="stylesheet" href="css/component.css"/>
    <link rel="stylesheet" href="css/conInput.css"/>
    <link rel="stylesheet" href="css/conMatch.css"/>
    <style type="text/css">
        .container {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            top: 0%;
            left: 0%;
        }

        /*productList*/
        #productList {

        }

        #productTitle {
            box-sizing: border-box;
            padding: 1rem;
        }

        #productContainer {
            height: 30rem;
            overflow: scroll;
        }

        #checkShop {
            width: 50%;
            margin: 1rem auto;
        }
    </style>
    <title>初始化</title>
</head>
<body>
<div class="container" id='conInput'>
    <div class="middle">
        <div class="nail"></div>
        <div class="toiletPaper">
            <div class="barCodeMenu">
                <div class='row' id='saoma'><img src="img/conInput/sm_icon.png" width="42" height="42">扫码录入</div>
                <div class="row" id="shoudong">手动输入条码</div>
            </div>
            <div class="handInputCon" style="display:none;">
                <div class="row"><input id="barcode" type="text" value='6923492540349' placeholder="请输入条形码"/></div>
                <div class="row"><span id="confirm">确定</span><span id="cancel">取消</span></div>
            </div>
        </div>
    </div>

    <div class="bottom">
        <div class="bottomTop"><span class='alreadyInsert'>已录入产品（92）</span><span class='insertCheck'>查看 ></span></div>
        <div id='finishInsert' class='normalBtn'> 完成录入</div>
    </div>
</div>


<div class="container" id='conMatch'>
    <div id="resultMask">
        <div id='resultMaskTop'>
            <span id='resultMaskTopR'><span id=resultMaskTopRCancel>×</span></span>
            <span id='resultMaskTopL'>产品匹配结果如下</span>
        </div>
        <div id='productCon'>
            <img id='pImg' src=""/>

            <div id="pName">屈臣氏植物水活保湿乳液</div>
            <div id="pBrand" style='color:#707070;'>品牌：屈臣氏</div>
            <div id="pCat" style='color:#707070;'>分类：护肤乳</div>
            <div id="pBarcode" style='color:#707070;'>条码：1235641657</div>
            <div id="finishMatch" class='normalBtn'>完成关联</div>
            <div id='cancelMatch' class='normalBtn'>取消</div>
        </div>
    </div>
</div>
<div class="container" id='conNotMatch'>
    没
</div>

<div class="container" id='productList'>
    <!--<div id='productTitle'>产品</div>-->
    <!--<div id='productContainer'></div>-->
    <!--<div id='checkShop' class='normalBtn'>店铺认证</div>-->
</div>

<script src='http://res.wx.qq.com/open/js/jweixin-1.1.0.js'></script>
<script src="http://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="js/tool/underscore.min.js"></script>
<script src='js/tool/response.js'></script>
<script src='js/controller/controller.js'></script>
<script src='js/globalManager/globalManager.js'></script>
<script src='js/tool/fastclick.js'></script>
<script src='js/constant/jimiHost.js'></script>

<script>
    $(function () {

        //debug.........................................................................
        window.onerror = function (sMsg, sUrl, sLine) {
            alert(sMsg);
            alert(sUrl);
            alert(sLine);
        }

        FastClick.attach(document.body);

        //localStorage..............................................................
        GM.uid = localStorage.getItem('uid');
        if (!GM.uid) {
            alert('请先登录');
            window.location.replace('login.html');
        }

        //initGM.............................................................
        //!!!一个产品六个字段 lineCode pid pname imgUrl brand cat
        GM.product = null;
        controller.getProductList({uid: GM.uid},
                function (json) {
                    GM.productList = json.list;
                    updateNumber();
                })


        //jqObj..............................................................
        $containers = $('.container');
        $conMatch = $('#conMatch');

        //initDom................................................................
        showPage('conInput');

        //bindEvent............................................................
        //conInput
        $('#finishInsert').click(function () {
            showPage('productList');
            appendProductList();
        })

        //conMatch
        $('#cancelMatch').click(function () {
            showPage('conInput');
        });
        $('#finishMatch').click(function () {
            var index = _.findLastIndex(GM.productList, {lineCode: GM.product.lineCode});
            //没录过
            if (index == -1) {

                GM.productList.push(GM.product);

                controller.saveProduct(GM.product, function () {
                    GM.product = null;
                    alert('关联成功');
                    updateNumber();
                    showPage('conInput');
                })

            } else {
                GM.product = null;
                alert('该产品已被录入');
                showPage('conInput');
            }
        });

        //notMatch..................................................
        $('#notMatchBack').click(function () {
            showPage('conInput');
        });

        //procuctList........................................
        $('#checkShop').click(function () {
            window.location.replace('shopAuthentication.html');
        });

        //initAjax........................................................
        $.ajax({
            type: "get",
            url: jimiHost + '/getWxConfig.php',
            dataType: "jsonp",
            jsonp: "callback",
            jsonpCallback: "jsonpcallback",
            async: false,
            data: {url: 'http://' + window.location.host + window.location.pathname},
            success: function (data) {
                console.log(JSON.stringify(data));

                wx.config({
                    debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                    appId: data.appId, // 必填，公众号的唯一标识
                    timestamp: data.timestamp + '', // 必填，生成签名的时间戳
                    nonceStr: data.nonceStr + '', // 必填，生成签名的随机串
                    signature: data.signature,// 必填，签名，见附录1
                    jsApiList: [
//                        'getLocation',
//                        'chooseImage',
//                        'openLocation',
                        'scanQRCode'
                    ]
                });


                wx.error(function (res) {
                    alert('wxConfigErr')
                    alert(res);

                });

                wx.ready(function () {
                    //bindEvent.............................................................
                    $('#saoma').click(function () {
                        wx.scanQRCode({
                            needResult: 1, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
                            scanType: ["barCode"], // 可以指定扫二维码还是一维码，默认二者都有
                            success: function (res) {
                                var errMsg = res.errMsg;
                                var result = res.resultStr; // 当needResult 为 1 时，扫码返回的结果
                                var lineCode = result.split(',')[1];

                                ajaxBarcode(lineCode);
                            }
                        });
                    });

                    $('#shoudong').click(function () {
                        $('.barCodeMenu').slideUp();
                        $('.handInputCon').slideDown();
                    });

                    $('#confirm').click(function () {
                        var lineCode = $('#barcode').val();
                        ajaxBarcode(lineCode);
                    })
                    $('#cancel').click(function () {
                        $('.handInputCon').slideUp();
                        $('.barCodeMenu').slideDown();
                    });


                    function ajaxBarcode(lineCode) {
                        controller.checkLineCode({
                            jsoncallback: 1,
                            regcode: lineCode,
                        }, function (json) {
                            if (Object.prototype.toString.call(json) == "[object Array]") {
                                var product = json[0];

                                var pid = product.pid;
                                var imgUrl = product.imgUrl || 'img/logo.jpg';
                                var pname = product.pname;
                                var category = product.category;
                                var brand = product.brand;

                                $conMatch.find('#pImg').attr('src', imgUrl);
                                $conMatch.find('#pName').html(pname);
                                $conMatch.find('#pBrand').html('品牌：' + brand);
                                $conMatch.find('#pCat').html('分类：' + category);
                                $conMatch.find('#pBarcode').html('条码：' + lineCode);
                                showPage('conMatch');
                                //product应该是数据层的json

                                GM.product = product;
                                GM.product.lineCode = lineCode;

                            } else {
                                showPage('conNotMatch');
                                GM.product = null;
                            }
                        })
                    }
                })

            },
            error: function (err) {
                console.log('ERROR!');
                console.log(err);
            }
        });


        //staticFns......................................................
        function showPage(id) {
            $('#' + id).show().siblings('.container').hide();
        }


        function updateNumber() {
            $('.alreadyInsert').html('已录入产品(' + GM.productList.length + ')');
        }


        function appendProductList() {
            var str = '';
            [].forEach.call(GM.productList, function (e, i, arr) {
                str += getProductStr(e);
            });

            $('#productContainer').html(str)
            initCSS($('#productContainer'));


            function getProductStr(json) {
                var str = "<div class='productCon' data-pid=" + json.pid + " >" +
                        "<img class='proImg' src='" + json.imgUrl + "' />" +

                        "<div class='textCon'>" +
                        "<div class='pName'>" + json.pname + "</div>" +
                        "<div class='pBrand'>" + json.brand + "</div>" +
                        "<div class='pCat'>" + json.category + "</div>" +
                        "</div>" +
                        "</div>"

                return str;
            }
        }

        function initCSS($C) {

            $C.find('.productCon').css({
                'box-sizing': 'border-box',
                width: '80%',
                border: '1px solid #c1c1c1',
                margin: '0 auto 1rem',
                position: 'relative',
                'padding-left': '7rem',
                'min-height': '7rem',
            })

            $C.find('.proImg').css({
                position: 'absolute',
                top: '1rem',
                left: '1rem',
                width: '5rem',
            })

            $C.find('.pName').css({
                margin: '1rem 0',
            })

            $C.find('.pBrand').css({
                margin: '1rem 0',
            })

            $C.find('.pCat').css({
                margin: '1rem 0',
            })


        }

    })
</script>
</body>
</html>